<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" > 

<mapper namespace="kpi">

    <!-- KPI 현황 리스트 -->
    <select id="getKpiList" parameterType="hashmap" resultType="hashmap">
		SET @DT = #{dt, jdbcType=VARCHAR};
		
		SELECT *
		FROM (
					SELECT
						C.CON_NM
						,SUM(CASE S.STATE WHEN 'A' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_A, 0) AS STA_CNT_A
						,SUM(CASE S.STATE WHEN 'B' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_B, 0) AS STA_CNT_B
						,SUM(CASE S.STATE WHEN 'C' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_C, 0) AS STA_CNT_C
						,SUM(CASE S.STATE WHEN 'D' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_D, 0) AS STA_CNT_D
						,SUM(CASE S.STATE WHEN 'G' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_G, 0) AS STA_CNT_G
						,SUM(CASE S.STATE WHEN 'H' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_H, 0) AS STA_CNT_H
						,IFNULL(A.COM_CNT, 0) COM_CNT
						,IFNULL(B.POS_CNT, 0) POS_CNT
						,IFNULL(D.USR_CNT, 0) USR_CNT
						,C.CON_ORDER
					FROM 
						I_CONSULTANT C LEFT OUTER JOIN I_PRO_STATUS S 
							ON (C.CON_ID = S.CON_ID AND S.DEL_DATE IS NULL AND DATE_FORMAT(S.STATE_DATE, '%Y%m') = @DT)
					LEFT OUTER JOIN
					(
						SELECT   
				   			SUM(CASE WHEN S.STATE = 'A' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_A
				   			,SUM(CASE WHEN S.STATE = 'B' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_B
				   			,SUM(CASE WHEN S.STATE = 'C' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_C
				   			,SUM(CASE WHEN S.STATE = 'D' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_D
				   			,SUM(CASE WHEN S.STATE = 'G' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_G
				   			,SUM(CASE WHEN S.STATE = 'H' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_H
								,P.CON_ID
							FROM I_PRO_STATUS S
								LEFT OUTER JOIN I_REC_PRESENT A ON (S.REC_ID = A.REC_ID)
								LEFT OUTER JOIN I_POSITION P ON (A.POS_ID = P.POS_ID)   
							WHERE
								S.del_date is null   
						 	 	AND P.CON_ID != S.CON_ID   
						 		AND DATE_FORMAT(S.STATE_DATE, '%Y%m') = @DT  
							GROUP BY P.CON_ID
					) POS_CNT ON(C.CON_ID = POS_CNT.CON_ID)
					LEFT OUTER JOIN 
					(
						SELECT COUNT(COMP.COM_ID) AS COM_CNT, COMP.CON_ID
						FROM I_COMPANY COMP
						WHERE
							COMP.DEL_DATE IS NULL
							AND DATE_FORMAT(COMP.REG_DATE, '%Y%m') = @DT
						GROUP BY COMP.CON_ID
					) A ON (C.CON_ID = A.CON_ID)	
					LEFT OUTER JOIN
					(
						SELECT COUNT(POS_ID) AS POS_CNT, P.CON_ID
						FROM I_POSITION P
						WHERE
							P.DEL_DATE IS NULL
							AND DATE_FORMAT(P.REG_DATE, '%Y%m') = @DT
						GROUP BY P.CON_ID
					) B ON (C.CON_ID = B.CON_ID)
					LEFT OUTER JOIN
					(
						SELECT COUNT(USR_ID) AS USR_CNT, U.CON_ID
						FROM I_USER U
						WHERE
							U.DEL_DATE IS NULL
							AND DATE_FORMAT(U.REG_DATE, '%Y%m') = @DT
						GROUP BY U.CON_ID
					) D ON (C.CON_ID = D.CON_ID)
					WHERE
						(C.DEL_DATE IS NULL OR DATE_FORMAT(C.DEL_DATE, '%Y%m') = @DT)
						AND CONVERT(DATE_FORMAT(C.REG_DATE, '%Y%m'), UNSIGNED) &lt;= CONVERT(@DT, UNSIGNED)
					GROUP BY C.CON_ID
					
					UNION
					
					SELECT 
						'합계'
						,SUM(STA_CNT_A)
						,SUM(STA_CNT_B)
						,SUM(STA_CNT_C)
						,SUM(STA_CNT_D)
						,SUM(STA_CNT_G)
						,SUM(STA_CNT_H)
						,SUM(COM_CNT)
						,SUM(POS_CNT)
						,SUM(USR_CNT)
						,999
					FROM(
							SELECT
								C.CON_NM
								,SUM(CASE S.STATE WHEN 'A' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_A, 0) AS STA_CNT_A
								,SUM(CASE S.STATE WHEN 'B' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_B, 0) AS STA_CNT_B
								,SUM(CASE S.STATE WHEN 'C' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_C, 0) AS STA_CNT_C
								,SUM(CASE S.STATE WHEN 'D' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_D, 0) AS STA_CNT_D
								,SUM(CASE S.STATE WHEN 'G' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_G, 0) AS STA_CNT_G
								,SUM(CASE S.STATE WHEN 'H' THEN 1 ELSE 0 END) + IFNULL(POS_CNT_H, 0) AS STA_CNT_H
								,IFNULL(A.COM_CNT, 0) COM_CNT
								,IFNULL(B.POS_CNT, 0) POS_CNT
								,IFNULL(D.USR_CNT, 0) USR_CNT
								,C.CON_ORDER
							FROM 
								I_CONSULTANT C LEFT OUTER JOIN I_PRO_STATUS S 
									ON (C.CON_ID = S.CON_ID AND S.DEL_DATE IS NULL AND DATE_FORMAT(S.STATE_DATE, '%Y%m') = @DT)
							LEFT OUTER JOIN
							(
								SELECT   
						   			SUM(CASE WHEN S.STATE = 'A' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_A
						   			,SUM(CASE WHEN S.STATE = 'B' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_B
						   			,SUM(CASE WHEN S.STATE = 'C' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_C
						   			,SUM(CASE WHEN S.STATE = 'D' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_D
						   			,SUM(CASE WHEN S.STATE = 'G' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_G
						   			,SUM(CASE WHEN S.STATE = 'H' AND P.CON_ID != A.CON_ID THEN 1 ELSE 0 END) AS POS_CNT_H
										,P.CON_ID
									FROM I_PRO_STATUS S
										LEFT OUTER JOIN I_REC_PRESENT A ON (S.REC_ID = A.REC_ID)   
										LEFT OUTER JOIN I_POSITION P ON (A.POS_ID = P.POS_ID)   
									WHERE    
										S.del_date is null   
								 	 	AND P.CON_ID != S.CON_ID   
								 		AND DATE_FORMAT(S.STATE_DATE, '%Y%m') = @DT  
									GROUP BY P.CON_ID
							) POS_CNT
								ON(C.CON_ID = POS_CNT.CON_ID)
							LEFT OUTER JOIN 
							(
								SELECT COUNT(COMP.COM_ID) AS COM_CNT, COMP.CON_ID
								FROM I_COMPANY COMP
								WHERE
									COMP.DEL_DATE IS NULL
									AND DATE_FORMAT(COMP.REG_DATE, '%Y%m') = @DT
								GROUP BY COMP.CON_ID
							) A ON (C.CON_ID = A.CON_ID)	
							LEFT OUTER JOIN
							(
								SELECT COUNT(POS_ID) AS POS_CNT, P.CON_ID
								FROM I_POSITION P
								WHERE
									P.DEL_DATE IS NULL
									AND DATE_FORMAT(P.REG_DATE, '%Y%m') = @DT
								GROUP BY P.CON_ID
							) B ON (C.CON_ID = B.CON_ID)
							LEFT OUTER JOIN
							(
								SELECT COUNT(USR_ID) AS USR_CNT, U.CON_ID
								FROM I_USER U
								WHERE
									U.DEL_DATE IS NULL
									AND DATE_FORMAT(U.REG_DATE, '%Y%m') = @DT
								GROUP BY U.CON_ID
							) D ON (C.CON_ID = D.CON_ID)
							WHERE
								(C.DEL_DATE IS NULL OR DATE_FORMAT(C.DEL_DATE, '%Y%m') = @DT)
								AND CONVERT(DATE_FORMAT(C.REG_DATE, '%Y%m'), UNSIGNED) &lt;= CONVERT(@DT, UNSIGNED)
							GROUP BY C.CON_ID
							) X
				) RESULT
				ORDER BY RESULT.CON_ORDER
    </select>
    
</mapper>